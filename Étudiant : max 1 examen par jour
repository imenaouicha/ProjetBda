CREATE OR REPLACE FUNCTION check_etudiant_un_exam_jour()
RETURNS TRIGGER AS $$
DECLARE
    exam_date DATE;
    nb_exams INT;
BEGIN
    -- Récupérer la date de l'examen lié à l'inscription
    SELECT DATE(e.date_heure) INTO exam_date
    FROM planning.examens e 
    WHERE e.id = NEW.examen_id;

    -- Compter combien d'examens l'étudiant a déjà ce jour-là
    SELECT COUNT(*) INTO nb_exams
    FROM planning.inscriptions i
    JOIN planning.examens e ON i.examen_id = e.id
    WHERE i.etudiant_id = NEW.etudiant_id
      AND DATE(e.date_heure) = exam_date;

    IF nb_exams >= 1 THEN
        RAISE EXCEPTION 'Conflit: étudiant déjà un examen ce jour';
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_etudiant_exam
BEFORE INSERT ON planning.inscriptions
FOR EACH ROW EXECUTE FUNCTION check_etudiant_un_exam_jour();
