CREATE OR REPLACE FUNCTION planning.check_salle_capacite()
RETURNS TRIGGER AS $$
DECLARE
    v_capacite INT;
    v_nb_inscrits INT;
BEGIN
    -- 1. Récupérer la capacité de la salle associée à l'examen
    -- On passe par la table examens car salle_id n'est pas dans inscriptions
    SELECT l.capacite INTO v_capacite
    FROM planning.lieu_examen l
    JOIN planning.examens e ON e.salle_id = l.id
    WHERE e.id = NEW.examen_id;

    -- 2. Compter le nombre d'étudiants déjà inscrits à cet examen
    SELECT COUNT(*) INTO v_nb_inscrits
    FROM planning.inscriptions
    WHERE examen_id = NEW.examen_id;

    -- 3. Vérifier si on dépasse la capacité
    -- (v_nb_inscrits + 1) car l'étudiant actuel n'est pas encore compté
    IF (v_nb_inscrits + 1) > v_capacite THEN
        RAISE EXCEPTION 'Action annulée : La salle est déjà pleine (Capacité max : %)', v_capacite;
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
