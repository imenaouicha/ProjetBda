CREATE OR REPLACE FUNCTION check_salle_capacite()
RETURNS TRIGGER AS $$
DECLARE
    capacite INT;
    nb_inscrits INT;
BEGIN
    SELECT l.capacite INTO capacite
    FROM planning.examens e
    JOIN planning.lieu_examen l ON e.salle_id = l.id
    WHERE e.id = NEW.examen_id;

    SELECT COUNT(*) INTO nb_inscrits
    FROM planning.inscriptions
    WHERE examen_id = NEW.examen_id;

    IF nb_inscrits >= capacite THEN
        RAISE EXCEPTION 'Capacité salle dépassée';
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_salle_capacite
BEFORE INSERT ON planning.inscriptions
FOR EACH ROW
EXECUTE FUNCTION check_salle_capacite();



